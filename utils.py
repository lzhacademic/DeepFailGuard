import os
import torch
import numpy as np
from scipy.stats import mode


def check_dir(path):
    dir_path = os.path.dirname(path)
    if not os.path.exists(dir_path):
        os.makedirs(dir_path)


def batch_infer(pytorch_model, dataloader, device=0):
    device = torch.device(f"cuda:{device}" if torch.cuda.is_available() else "cpu")
    predictions = []
    with torch.no_grad():
        for images, labels in dataloader:
            images, labels = images.to(device), labels.to(device)
            outputs = pytorch_model(images)
            _, predicted = torch.max(outputs.data, 1)
            predictions.extend(predicted.cpu().numpy())
    return predictions


def val_acc_map(model_name, dataset_name, bug_id):
    val_acc = {
        'CIFAR10': {
            'resnet': [80.58, 78.19, 67.62, 76.92, 72.00, 69.47, 76.39, 70.13, 70.15, 40.86, 80.58, 80.58, 80.58],
            'alexnet': [78.83, 71.90, 71.87, 73.55, 76.07, 64.68, 69.23, 69.31, 63.68, 46.20, 78.83, 78.83, 78.83],
            'densenet': [86.03, 82.87, 85.50, 82.73, 84.40, 73.60, 81.11, 76.67, 75.35, 58.00, 86.03, 86.03, 86.03],
            'squeezenet': [79.92, 80.51, 79.77, 79.64, 79.30, 59.92, 79.44, 79.73, 76.80, 72.45, 79.92, 79.92, 79.92],
            'vgg16': [80.39, 80.56, 82.34, 81.78, 80.10, 80.36, 79.80, 79.99, 73.91, 75.26, 80.39, 80.39, 80.39],
        },
        'ATS': {
            'resnet': [99.19, 98.38, 98.27, 97.09, 97.47, 91.24, 99.15, 98.21, 93.72, 94.22, 99.19],
            'alexnet': [98.43, 99.12, 98.72, 99.11, 99.07, 97.20, 99.22, None, 96.11, 97.38, 98.43],
            'densenet': [99.38, 98.97, 96.88, 99.35, 98.26, 95.32, 98.98, 98.57, 99.19, 96.49, 99.38],
            'squeezenet': [98.29, 94.50, 89.38, 90.27, 89.95, 90.70, 95.52, 98.30, 91.81, 88.28, 98.29],
            'vgg16': [99.35, 98.79, 99.11, 99.31, 99.16, 98.79, 99.04, None, 93.80, 98.68, 99.35],
        },
        'GTSRB': {
            'resnet': [99.82, 99.62, 99.49, 99.55, 99.59, 98.84, 98.14, 99.11, 95.66, 98.94, 99.82],
            'alexnet': [98.66, 98.76, 98.50, 98.60, 98.79, 72.19, 98.53, 55.22, 98.71, 96.09, 98.66],
            'densenet': [98.13, 97.59, 98.09, 99.71, 99.35, 97.84, 99.66, 99.69, 91.78, 99.31, 98.13],
            'squeezenet': [97.73, 93.75, 96.09, 95.98, 97.41, 81.08, 94.70, 95.45, 95.38, 91.48, 97.73],
            'vgg16': [99.36, 99.78, 99.62, 99.76, 99.69, 99.31, 99.80, None, 96.14, 99.44, 99.36],
        },
        'TSCD': {
            'resnet': [99.84, 99.71, 98.52, 99.15, 99.11, 97.14, 99.16, 99.81, 94.54, 99.09, 99.84],
            'alexnet': [98.43, 99.39, 99.21, 99.33, 99.27, 90.85, 99.27, 90.93, 98.93, 97.66, 98.43],
            'densenet': [99.47, 99.89, 99.83, 99.60, 99.83, 98.72, 99.60, 99.84, 93.83, 99.20, 99.47],
            'squeezenet': [99.90, 95.58, 91.28, 98.10, 97.56, 75.02, 93.14, 98.01, 94.72, 93.57, 99.90],
            'vgg16': [99.72, 99.74, 99.87, 99.85, 99.65, 98.79, 99.75, None, 95.37, 99.21, 99.72],
        },
        'CTSD': {
            'resnet': [98.08, 97.84, 96.16, 95.92, 91.73, 68.47, 95.68, 95.44, 88.37, 74.10, 98.08],
            'alexnet': [87.17, 79.14, 64.63, 59.47, 47.36, None, 67.63, None, 59.59, 35.61, 87.17],
            'densenet': [99.04, 98.20, 96.88, 98.20, 97.60, 88.73, 98.32, 97.72, 92.09, 88.61, 99.04],
            'squeezenet': [97.84, 84.89, 82.85, 89.09, 88.49, 40.89, 84.89, 60.91, 84.77, 82.97, 97.84],
            'vgg16': [99.28, 99.52, 95.68, 98.44, 98.56, 43.65, 97.84, None, 93.05, 90.77, 99.28],
        },
        'TTS': {
            'resnet': [99.97, 98.41, 95.85, 99.68, 99.38, 98.26, 97.76, 98.15, 94.06, 95.68, 99.97],
            'alexnet': [96.97, 96.71, 97.00, 97.26, 97.59, 53.76, 96.24, 69.00, 96.56, 89.91, 96.97],
            'densenet': [99.85, 99.91, 99.71, 99.82, 99.76, 98.68, 99.97, 99.94, 98.59, 99.29, 99.85],
            'squeezenet': [99.88, 97.65, 96.91, 97.50, 98.03, 79.15, 98.09, 97.94, 97.65, 89.79, 99.88],
            'vgg16': [99.15, 99.32, 98.50, 98.91, 99.06, 97.97, 99.35, 97.91, 93.59, 97.50, 99.15],
        },
        'COVIDX9A': {
            'resnet': [94.11, 91.07, 94.87, 91.56, 94.97, 91.11, 92.10, 93.44, 77.04, 92.26, 94.11],
            'alexnet': [93.84, 94.20, 94.03, 93.30, 95.12, 93.32, 94.60, 94.57, 90.89, 92.69, 93.84],
            'densenet': [95.12, 96.04, 95.77, 92.91, 95.31, 93.96, 90.50, 95.97, 93.50, 93.94, 95.12],
            'squeezenet': [93.57, 94.47, 94.52, 93.54, 94.67, 91.46, 94.70, 94.38, 93.20, 92.46, 93.57],
            'vgg16': [95.02, 94.82, 94.53, 94.92, 94.57, 94.55, 94.69, 95.12, 92.83, 92.46, 95.02],
        },
    }
    try:
        result = val_acc[dataset_name][model_name][bug_id] / 100
        return result
    except:
        return None

def test_acc_map(model_name, dataset_name, bug_id):
    test_acc = {
        'CIFAR10': {
            'resnet': [80.16, 78.37, 67.15, 76.13, 70.47, 68.40, 76.66, 70.21, 69.53, 40.55, 74.99, 68.33, 68.75],
            'alexnet': [78.53, 71.95, 70.74, 72.84, 74.87, 64.12, 68.93, 68.29, 62.85, 45.09, 77.07, 65.41, 65.70],
            'densenet': [86.08, 82.97, 84.57, 82.08, 84.02, 72.88, 80.99, 75.87, 73.77, 58.52, 78.15, 74.81, 75.70],
            'squeezenet': [80.41, 79.75, 79.63, 79.25, 79.07, 60.22, 79.03, 79.64, 76.48, 71.29, 73.36, 66.75, 67.65],
            'vgg16': [79.92, 79.85, 81.94, 81.36, 79.79, 79.39, 79.09, 79.34, 73.17, 74.05, 76.15, 65.17, 66.00],
        },
        'ATS': {
            'resnet': [96.41, 94.28, 96.02, 93.99, 94.48, 84.80, 96.87, 94.84, 86.54, 90.39, 95.96],
            'alexnet': [93.29, 95.38, 95.10, 95.73, 95.90, 92.51, 95.76, None, 92.01, 93.56, 91.99],
            'densenet': [97.59, 97.60, 93.46, 97.53, 95.60, 89.94, 96.73, 96.55, 97.40, 92.54, 97.44],
            'squeezenet': [94.75, 88.94, 84.66, 85.42, 85.50, 87.51, 90.68, 95.04, 86.77, 83.01, 94.34],
            'vgg16': [97.60, 95.84, 96.42, 97.30, 97.03, 96.38, 97.07, None, 92.91, 96.50, 97.20],
        },
        'GTSRB': {
            'resnet': [98.17, 97.13, 95.51, 96.18, 96.09, 90.63, 92.67, 95.11, 86.30, 91.84, 96.48],
            'alexnet': [90.96, 87.27, 90.12, 91.11, 90.85, 66.57, 88.86, 47.19, 90.74, 87.32, 84.85],
            'densenet': [81.34, 88.03, 84.95, 89.50, 88.69, 76.51, 89.07, 91.22, 69.96, 84.53, 63.90],
            'squeezenet': [89.90, 87.04, 89.19, 89.71, 91.75, 75.68, 87.95, 87.41, 88.73, 84.26, 85.32],
            'vgg16': [96.65, 97.67, 96.92, 98.25, 97.77, 96.11, 97.70, None, 91.49, 96.19, 93.78],
        },
        'TSCD': {
            'resnet': [99.88, 99.64, 98.46, 99.16, 99.12, 97.07, 99.28, 99.81, 94.62, 99.12, 97.47],
            'alexnet': [98.58, 99.33, 99.25, 99.26, 99.17, 90.87, 99.28, 90.98, 98.91, 97.83, 92.54],
            'densenet': [99.69, 99.91, 99.90, 99.57, 99.87, 98.85, 99.68, 99.88, 94.14, 99.16, 81.08],
            'squeezenet': [99.95, 95.84, 90.98, 98.09, 97.63, 75.16, 93.27, 97.98, 95.00, 93.74, 98.62],
            'vgg16': [99.85, 99.81, 99.92, 99.96, 99.72, 99.14, 99.80, None, 95.25, 99.31, 98.38],
        },
        'CTSD': {
            'resnet': [40.52, 43.53, 34.80, 35.91, 32.30, 22.97, 34.80, 32.90, 31.49, 22.17, 39.92],
            'alexnet': [45.24, 37.61, 31.59, 31.19, 25.18, None, 30.29, None, 32.00, 24.17, 44.73],
            'densenet': [45.84, 44.33, 42.73, 44.43, 44.38, 37.01, 43.23, 40.02, 37.71, 39.12, 42.98],
            'squeezenet': [51.25, 45.94, 43.33, 46.14, 45.74, 21.87, 44.33, 28.59, 42.93, 45.44, 49.90],
            'vgg16': [51.96, 55.37, 47.84, 52.46, 55.07, 26.88, 56.17, None, 59.98, 49.05, 51.00],
        },
        'TTS': {
            'resnet': [99.95, 98.71, 95.98, 99.55, 99.22, 97.72, 98.45, 98.68, 94.73, 96.12, 99.93],
            'alexnet': [96.59, 96.02, 96.89, 97.32, 96.85, 55.01, 96.47, 67.69, 97.08, 90.16, 96.59],
            'densenet': [99.67, 99.95, 99.72, 99.84, 99.67, 98.56, 99.91, 99.91, 98.82, 99.34, 99.25],
            'squeezenet': [99.88, 97.20, 96.64, 97.65, 98.42, 79.88, 97.65, 98.02, 97.55, 90.12, 99.86],
            'vgg16': [98.94, 99.34, 98.19, 98.99, 99.22, 97.86, 99.06, 98.21, 94.56, 96.96, 98.92],
        },
        'COVIDX9A': {
            'resnet': [88.00, 88.50, 88.50, 84.25, 91.50, 86.50, 97.75, 87.50, 68.75, 86.75, 78.50],
            'alexnet': [92.50, 88.75, 86.75, 87.75, 95.25, 91.25, 93.25, 87.75, 87.25, 86.50, 88.50],
            'densenet': [94.75, 94.00, 90.75, 94.25, 92.50, 79.25, 86.50, 88.50, 90.00, 88.50, 85.25],
            'squeezenet': [85.00, 88.50, 91.25, 85.50, 89.25, 73.75, 84.50, 87.00, 85.25, 86.75, 79.75],
            'vgg16': [91.50, 87.25, 86.75, 92.00, 90.75, 87.00, 90.75, 92.75, 88.50, 86.00, 87.75],
        },
    }
    try:
        result = test_acc[dataset_name][model_name][bug_id] / 100
        return result
    except:
        return None


def nvp_results(all_model_labels):
    all_model_labels = np.array(all_model_labels)
    nvp_labels = mode(all_model_labels, axis=0)[0]
    return nvp_labels


def cal_upper_limit(all_model_labels, ground_truth):
    ground_truth = np.array(ground_truth)
    all_model_labels = np.array(all_model_labels)
    correct_predictions = np.any(all_model_labels == ground_truth, axis=0)
    upper_limit = np.sum(correct_predictions)/len(ground_truth)
    return upper_limit


def cal_available_model(dataset_name, bug_id):
    all_models = [
        'resnet', 'alexnet', 'densenet', 'vgg16', 'squeezenet',
    ]
    available_model = []
    for model_name in all_models:
        if val_acc_map(model_name, dataset_name, bug_id) is not None:
            available_model.append(model_name)
    return available_model

